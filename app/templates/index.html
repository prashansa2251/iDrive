{%extends 'base.html'%}
{%block title%}Files{%endblock%}
{%block css%}
<style>
    .file-card {
        transition: transform 0.2s;
    }
    .file-card:hover {
        transform: scale(1.05);
    }
    /* New styles for directory cursor and hover effect */
    .directory-item {
        cursor: pointer;
    }
    .directory-item:hover {
        background-color: rgba(0,0,0,0.05);
    }
</style>
{%endblock%}
{%block content%}

<section id="withFiles" class="d-none">
    
    <div class="row mt-4">

        <div class="col-md-3 justify-content-start d-flex" id="storageStatus"></div>
        <div class="col-md-6">
            <div class="input-group pt-3">
                <input type="text" id="searchInput" class="form-control rounded-start-5" placeholder="Search Files"
                    aria-describedby="searchInput_2">
                <span class="input-group-text rounded-end-5" id="searchInput_2">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </span>
            </div>
        </div>
        <div class="col-md-3 d-flex justify-content-end">
            <a type="button" class="btn btn-primary mt-3 me-2" href="/upload">
                <i class="fa-solid fa-plus"></i> <span class="ms-2">New</span>
            </a>
        </div>
    </div>
    <section>
        <div class="row">
            <div class="col">
                <ol id="breadcrumb" class="breadcrumb" style="border: none; box-shadow: none;" ></ol>
            </div>
            <div class="col-md-2 pt-3 align-items-center justify-content-end d-flex" id="viewToggleBtn">
                <div class="view-toggle d-flex justify-content-end mb-3">
                    <div class="btn-group border" role="group">
                        <button type="button" class="btn btn-secondary active text-primary no-loader" id="cardViewBtn">
                            <i class="fa-solid fa-table-cells-large fa-lg"></i><i class="fa-solid fa-check ms-1 fa-sm"></i>
                        </button>
                        <button type="button" class="btn btn-secondary no-loader" id="tableViewBtn">
                            <i class="fa-solid fa-list-ul fa-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Card View Container -->
    <div id="cardView" class="row row-cols-1 row-cols-md-4 row-cols-lg-5 g-4" style="display: flex;">
        <!-- Files will be dynamically populated here -->
    </div>
    
    <!-- Table View Container -->
    <div id="tableView" style="display: none;">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th class="text-center">Type</th>
                    <th>Name</th>
                    <th>Size</th>
                    <th>Last Modified</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Files will be dynamically populated here -->
            </tbody>
        </table>
    </div>
</section>
<section id="noFiles" class="d-none">
    <div class="text-center py-5" >
        <div class="display-1 text-muted mb-3">
            <i class="bi bi-cloud-upload"></i>
        </div>
        <h2 class="text-muted">No files uploaded yet</h2>
        <p class="lead">Upload your first file to get started</p>
        <a type="button" class="btn btn-primary" href="/upload">
            <i class="fa-solid fa-plus"></i> <span class="ms-2">Upload New File</span>
        </a>
    </div>
</section>
{%endblock%}

{%block scripts%}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const cardViewBtn = document.getElementById('cardViewBtn');
    const tableViewBtn = document.getElementById('tableViewBtn');
    const cardView = document.getElementById('cardView');
    const tableView = document.getElementById('tableView');
    const noFiles = document.getElementById('noFiles');
    const withFiles = document.getElementById('withFiles');
    const breadcrumb = document.getElementById('breadcrumb');
    const searchInput = document.getElementById('searchInput');

    let currentPath = ''; // Tracks the current directory path
    let allItems = []; // Store all items from current directory for filtering

    // Toggle Views (unchanged)
    cardViewBtn.addEventListener('click', function () {
        cardView.style.display = 'flex';
        tableView.style.display = 'none';
        cardViewBtn.innerHTML = '<i class="fa-solid fa-table-cells-large fa-lg"></i><i class="fa-solid fa-check ms-1 fa-sm"></i>'
        tableViewBtn.innerHTML = '<i class="fa-solid fa-list-ul fa-lg"></i>'
        cardViewBtn.classList.add('text-primary');
        tableViewBtn.classList.remove('text-primary');
    });

    tableViewBtn.addEventListener('click', function () {
        cardView.style.display = 'none';
        tableView.style.display = 'block';
        tableViewBtn.innerHTML = '<i class="fa-solid fa-list-ul fa-lg"></i><i class="fa-solid fa-check ms-1 fa-sm"></i>'
        cardViewBtn.innerHTML = '<i class="fa-solid fa-table-cells-large fa-lg"></i>'
        tableViewBtn.classList.add('text-primary');
        cardViewBtn.classList.remove('text-primary');
    });

    // Search functionality
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        filterItems(searchTerm);
    });
    async function fetchStorageStatus() {
    try {
        const response = await fetch('/storage_status', { method: 'POST' });
        const data = await response.json();

        const storageContainer = document.getElementById('storageStatus');
        if (!storageContainer) return;

        const { used, allocated, danger, percentage } = data;

        // Determine danger class for text and progress bar
        const dangerClass = danger ? 'text-danger' : '';
        const progressBarClass = danger ? 'bg-danger' : '';

        // Update the HTML inside #storageStatus
        storageContainer.innerHTML = `
            <div class="container p-0 m-0 ms-3 ${dangerClass}" style="width: 50%;">
                <span class="fs-8"><i class="fa-solid fa-cloud"></i> Storage (${percentage}% Full)</span>
                <div class="progress" role="progressbar" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100" style="height: 5px;">
                    <div class="progress-bar ${progressBarClass}" style="width: ${percentage}%;"></div>
                </div>
                <span class="fs-8">${used} of ${allocated} used</span>
            </div>
        `;
    } catch (error) {
        console.error("Error fetching storage status:", error);
    }
}

    function filterItems(searchTerm) {
        if (!searchTerm) {
            // If search is empty, show all items
            updateCardView(allItems);
            updateTableView(allItems);
            return;
        }

        const filteredItems = allItems.filter(item => 
            item.name.toLowerCase().includes(searchTerm)
        );

        // Update views with filtered items
        updateCardView(filteredItems);
        updateTableView(filteredItems);
        
        // Show/hide empty state
        if (filteredItems.length === 0) {
            cardView.innerHTML = `<div class="col-12 text-center py-5">
                <p class="text-muted">No files matched your search</p>
            </div>`;
            tableView.querySelector('tbody').innerHTML = `<tr>
                <td colspan="5" class="text-center py-4">No files matched your search</td>
            </tr>`;
        }
    }

    // Fetch Directories & Files
    window.fetchFileList = function(folderPath = '') {
        fetchStorageStatus();
        console.log("Fetching folder:", folderPath);
        toggleSpinner();
        fetch('/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: folderPath })
        })
        .then(response => response.json())
        .then(data => {
            console.log("API Response:", data);

            if (data.error) {
                console.error("Error fetching files:", data.error);
                toggleSpinner();
                return;
            }

            currentPath = folderPath;
            updateBreadcrumb();
            
            // Clear search when navigating
            searchInput.value = '';
            
            // Store all items for search filtering
            allItems = data;

            if (data.length === 0) {
                noFiles.classList.remove('d-none');
                withFiles.classList.add('d-none');
            } else {
                noFiles.classList.add('d-none');
                withFiles.classList.remove('d-none');
                updateCardView(data);
                updateTableView(data);
            }
            toggleSpinner();
        })
        .catch(error => {
            console.error("Fetch error:", error);
            toggleSpinner();
        });
    };

    // Update Breadcrumb & Back Button (unchanged)
    function updateBreadcrumb() {
        breadcrumb.innerHTML = '';
        const parts = currentPath.split('/').filter(p => p);
        
        let pathSoFar = '';
        breadcrumb.innerHTML = `<li class="breadcrumb-item"><a href="#" onclick="fetchFileList('')">Home</a></li>`;

        parts.forEach((part, index) => {

            let foldername = part.split('_').slice(1).join('_');
            pathSoFar += (index > 0 ? '/' : '') + foldername;
            if (index === parts.length - 1) {
                breadcrumb.innerHTML += `<li class="breadcrumb-item active">${formatFolderName(foldername)}</li>`;
            } else {
                breadcrumb.innerHTML += `<li class="breadcrumb-item"><a href="#" onclick="fetchFileList('${pathSoFar}')">${part}</a></li>`;
            }
        });
    }

    // Update Card View
    function updateCardView(items) {
        const cardViewContainer = document.getElementById("cardView");
        cardViewContainer.innerHTML = ""; // Clear existing cards

        items.forEach(item => {
            let cardHTML = `
            <div class="col">
                <div class="card h-100 file-card ${item.is_directory ? 'directory-item' : ''}">
                    <div class="card-body text-center">
                        <div class="file-icon fs-1 mb-3">${item.is_directory ? '<i class="bi bi-folder"></i>' : getFileIcon(item.original_filename)}</div>
                        <h5 class="card-title text-truncate" title="${item.is_directory ? formatFolderName(item.name) : item.name}">
                            ${item.is_directory ? formatFolderName(item.name) : item.name}
                        </h5>
                        <p class="card-text text-muted">${item.is_directory ? item.size+'/'+item.allocated_storage : item.size}</p>
                        <p class="card-text text-muted small">${item.upload_date || ''}</p>
                        ${item.is_directory ? `
                            <div class="mt-3 d-flex justify-content-center">
                                <button onclick="fetchFileList('${item.path}')" class="btn btn-sm btn-outline-primary">Open Folder</button>
                            </div>
                        ` : `
                            <div class="mt-3 d-flex justify-content-center gap-2">
                                <a href="/stream_download/${item.path}" class="btn btn-sm btn-outline-primary" onclick="handleDownload(event,this);">Download</a>
                                <button onclick="event.stopPropagation(); deleteFile('${item.path}','${item.name}')" class="btn btn-sm btn-outline-danger">Delete</button>
                            </div>
                        `}
                    </div>
                </div>
            </div>
            `;
            cardViewContainer.innerHTML += cardHTML;
        });
    }

    // Update Table View
    function updateTableView(items) {
        const tableBody = document.querySelector("#tableView tbody");
        tableBody.innerHTML = ""; // Clear existing table rows

        items.forEach(item => {
            let rowHTML = `
            <tr>
                <td class="text-center fs-4">${item.is_directory ? '<i class="bi bi-folder"></i>' : getFileIcon(item.original_filename)}</td>
                <td>${item.is_directory ? formatFolderName(item.name) : item.name}</td>
                <td>${item.size}</td>
                <td>${item.upload_date || ''}</td>
                <td>
                    ${item.is_directory ? `
                        <button onclick="fetchFileList('${item.path}')" class="btn btn-sm btn-outline-primary">Open Folder</button>
                    ` : `
                        <div class="d-flex gap-2">
                            <a href="/stream_download/${item.path}" class="btn btn-sm btn-outline-primary" onclick="handleDownload(event,this);">Download</a>
                            <button onclick="event.stopPropagation(); deleteFile('${item.path}','${item.name}')" class="btn btn-sm btn-outline-danger">Delete</button>
                        </div>
                    `}
                </td>
            </tr>
            `;
            tableBody.innerHTML += rowHTML;
        });
    }
    window.handleDownload = function(event, button) {
    toggleSpinner();
    event.stopPropagation(); // Prevent parent click events

    // Wait for ~2 seconds (simulate download start)
    setTimeout(() => {
        toggleSpinner();
    }, 2000);
}

    // Delete File Function
    window.deleteFile = function(path, name) {
    if (confirm(`Are you sure you want to delete ${name}?`)) {
        fetch(`/delete/${path}`, {
            method: 'POST'
        })
        .then(response => response.json())  // Parse JSON response
        .then(data => {
            if (data.message) {
                message = data.message;
                fetchFileList(currentPath);
                showToast(message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the file');
        });
    }
};

    // Function to determine file icons based on filename extension
    window.getFileIcon = function(filename) {
        if (!filename) return '<i class="bi bi-file-earmark"></i>';
        
        const extension = filename.split('.').pop().toLowerCase();
        
        // Image files
        if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'].includes(extension)) {
            return '<i class="bi bi-file-image"></i>';
        }
        
        // Video files
        if (['mp4', 'mov', 'avi', 'mkv', 'webm', 'flv', 'wmv'].includes(extension)) {
            return '<i class="bi bi-file-play"></i>';
        }
        
        // Audio files
        if (['mp3', 'wav', 'ogg', 'flac', 'm4a', 'aac'].includes(extension)) {
            return '<i class="bi bi-file-music"></i>';
        }
        
        // Document files
        if (['pdf'].includes(extension)) {
            return '<i class="bi bi-file-pdf"></i>';
        }
        
        if (['doc', 'docx', 'rtf', 'txt', 'odt'].includes(extension)) {
            return '<i class="bi bi-file-word"></i>';
        }
        
        if (['xls', 'xlsx', 'csv', 'ods'].includes(extension)) {
            return '<i class="bi bi-file-spreadsheet"></i>';
        }
        
        if (['ppt', 'pptx', 'odp'].includes(extension)) {
            return '<i class="bi bi-file-slides"></i>';
        }
        
        // Archive files
        if (['zip', 'rar', '7z', 'tar', 'gz'].includes(extension)) {
            return '<i class="bi bi-file-zip"></i>';
        }
        
        // Code files
        if (['html', 'css', 'js', 'php', 'py', 'java', 'c', 'cpp', 'json'].includes(extension)) {
            return '<i class="bi bi-file-code"></i>';
        }
        
        // Default file icon
        return '<i class="bi bi-file-earmark"></i>';
    };
    
    function formatFolderName(input) {
    return input.split('_') // Split by underscore
                .map(word => word.charAt(0).toUpperCase() + word.slice(1)) // Capitalize each word
                .join(' '); // Join with space
}
    // Initial Fetch
    fetchFileList();
});
    
</script>
{%endblock%}