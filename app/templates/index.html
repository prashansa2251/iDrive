{%extends 'base.html'%}
{%block title%}Files{%endblock%}
{%block css%}
<style>
    .file-drop-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 1050;
        backdrop-filter: blur(5px);
    }

    .file-drop-card {
        max-width: 600px;
        margin: 10% auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .file-drop-area {
        border: 2px dashed #6c757d;
        border-radius: 20px;
        padding: 40px 20px;
        text-align: center;
        transition: background-color 0.3s ease;
    }

    .file-drop-area.dragover {
        background-color: rgba(0, 123, 255, 0.1);
        border-color: #007bff;
    }

    #fileList {
        max-height: 300px;
        overflow-y: auto;
    }

    .file-upload-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        position: relative;
    }

    .upload-progress-card {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 350px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1100;
        padding: 15px;
    }

    .upload-progress-item {
        margin-bottom: 10px;
        position: relative;
    }

    .upload-progress-bar {
        height: 5px;
        background-color: #e9ecef;
        border-radius: 5px;
        overflow: hidden;
        margin-top: 5px;
    }

    .upload-progress-bar-fill {
        height: 100%;
        background-color: #28a745;
        width: 0%;
        transition: width 0.5s ease;
    }

    .upload-details {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
    }
</style>
{%endblock%}
{%block content%}
<div class="row my-4">
    <div class="col-md-2">
        <button type="button" class="btn btn-primary" id="showUploadOverlay">
            <i class="fa-solid fa-plus"></i> <span class="ms-2">New</span>
        </button>
    </div>
    <div class="col-md-8">
        <div class="input-group">
            <input type="text" id="searchInput" class="form-control rounded-start-5" placeholder="Search Files"
                aria-describedby="searchInput_2">
            <span class="input-group-text rounded-end-5" id="searchInput_2"><i
                    class="fa-solid fa-magnifying-glass"></i></span>
        </div>
    </div>
    <div class="col-md-2 d-flex align-items-center justify-content-end" id="viewToggleBtn">
        {%if files%}
        <div class="view-toggle d-flex justify-content-end mb-3">
            <div class="btn-group border" role="group">
                <button type="button" class="btn btn-secondary active text-primary" id="cardViewBtn">
                    <i class="fa-solid fa-table-cells-large fa-lg"></i><i class="fa-solid fa-check ms-1 fa-sm"></i>
                </button>
                <button type="button" class="btn btn-secondary" id="tableViewBtn">
                    <i class="fa-solid fa-list-ul fa-lg"></i>
                </button>
            </div>
        </div>
        {%endif%}
    </div>
</div>
<div id="fileDropOverlay" class="file-drop-overlay">
    <div class="file-drop-card card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Upload Files</h5>
            <button id="closeOverlay" class="btn-close" aria-label="Close"></button>
        </div>
        <div class="card-body">
            <div id="dropArea" class="file-drop-area">
                <p class="text-muted mb-3">Drag and drop files here or click to select</p>
                <input type="file" id="fileInput" multiple class="form-control" style="display:none;">
                <button id="selectFiles" class="btn btn-outline-primary">Select Files</button>
            </div>

            <div id="fileList" class="mt-3">
                <!-- Selected files will be listed here -->
            </div>

            <div class="mt-3 d-flex justify-content-end">
                <button id="uploadFiles" class="btn btn-primary">Upload Files</button>
            </div>
        </div>
    </div>
</div>

<div id="uploadProgressCard" class="upload-progress-card" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">Upload Progress</h6>
        <button id="cancelUpload" class="btn btn-sm btn-outline-danger">&times;</button>
    </div>
    <div id="uploadProgressList">
        <!-- Upload progress items will be added here -->
    </div>
</div>




<!-- Card View -->
<div class="row row-cols-1 row-cols-md-4 row-cols-lg-5 g-4" id="cardView" {% if files %}style="display: flex;"{% else %}style="display: none;"{% endif %}>
    {% for file in files %}
    <div class="col">
        <div class="card h-100 file-card">
            <div class="card-body text-center">
                <div class="file-icon">
                    {% if file.mimetype.startswith('image/') %}
                    <i class="bi bi-file-image"></i>
                    {% elif file.mimetype.startswith('video/') %}
                    <i class="bi bi-file-play"></i>
                    {% elif file.mimetype.startswith('audio/') %}
                    <i class="bi bi-file-music"></i>
                    {% elif file.mimetype == 'application/pdf' %}
                    <i class="bi bi-file-pdf"></i>
                    {% elif 'spreadsheet' in file.mimetype or 'excel' in file.mimetype %}
                    <i class="bi bi-file-spreadsheet"></i>
                    {% elif 'document' in file.mimetype or 'word' in file.mimetype %}
                    <i class="bi bi-file-word"></i>
                    {% else %}
                    <i class="bi bi-file-earmark"></i>
                    {% endif %}
                </div>
                <h5 class="card-title text-truncate" title="{{ file.original_filename }}">{{
                    file.original_filename }}</h5>
                <p class="card-text text-muted">{{ (file.size / 1024)|round(1) }} KB</p>
                <p class="card-text text-muted small">{{ file.upload_date }}</p>
                <div class="d-flex justify-content-center mt-3">
                    <a href="{{ url_for('drive.download', file_id=file.id, original_filename=file.original_filename) }}"
                        class="btn btn-sm btn-outline-primary me-2">Download</a>
                    <form
                        action="{{ url_for('drive.delete', file_id=file.id, original_filename=file.original_filename) }}"
                        method="post" onsubmit="return confirm('Are you sure you want to delete this file?');">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Table View (Hidden by default) -->
<div id="tableView" style="display: none;">
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th class="text-center">Type</th>
                    <th>Filename</th>
                    <th>Size</th>
                    <th>Upload Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for file in files %}
                <tr>
                    <td class="text-center">
                        <div class="text-center">
                            {% if file.mimetype.startswith('image/') %}
                            <i class="bi bi-file-image"></i>
                            {% elif file.mimetype.startswith('video/') %}
                            <i class="bi bi-file-play"></i>
                            {% elif file.mimetype.startswith('audio/') %}
                            <i class="bi bi-file-music"></i>
                            {% elif file.mimetype == 'application/pdf' %}
                            <i class="bi bi-file-pdf"></i>
                            {% elif 'spreadsheet' in file.mimetype or 'excel' in file.mimetype %}
                            <i class="bi bi-file-spreadsheet"></i>
                            {% elif 'document' in file.mimetype or 'word' in file.mimetype %}
                            <i class="bi bi-file-word"></i>
                            {% else %}
                            <i class="bi bi-file-earmark"></i>
                            {% endif %}
                        </div>
                    </td>
                    <td title="{{ file.original_filename }}">{{ file.original_filename }}</td>
                    <td>{{ (file.size / 1024)|round(1) }} KB</td>
                    <td>{{ file.upload_date }}</td>
                    <td>
                        <div class="d-flex">
                            <a href="{{ url_for('drive.download', file_id=file.id, original_filename=file.original_filename) }}"
                                class="btn btn-sm btn-outline-primary me-2">Download</a>
                            <form
                                action="{{ url_for('drive.delete', file_id=file.id, original_filename=file.original_filename) }}"
                                method="post" onsubmit="return confirm('Are you sure you want to delete this file?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<div class="text-center py-5" id="noFile"  {% if files %}style="display: none;"{% else %}style="display: block;"{% endif %}>
    <div class="display-1 text-muted mb-3">
        <i class="bi bi-cloud-upload"></i>
    </div>
    <h2 class="text-muted">No files uploaded yet</h2>
    <p class="lead">Upload your first file to get started</p>
</div>
{%endblock%}
{%block scripts%}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const cardViewBtn = document.getElementById('cardViewBtn');
        const tableViewBtn = document.getElementById('tableViewBtn');
        const cardView = document.getElementById('cardView');
        const tableView = document.getElementById('tableView');
        const noFile = document.getElementById('noFile');
        const viewToggleBtn = document.getElementById('viewToggleBtn');

        cardViewBtn.addEventListener('click', function () {
            cardView.style.display = 'flex';
            tableView.style.display = 'none';
            cardViewBtn.classList.add('text-primary');
            tableViewBtn.classList.remove('text-primary');
            cardViewBtn.innerHTML = '<i class="fa-solid fa-table-cells-large fa-lg"></i><i class="fa-solid fa-check ms-1 fa-sm"></i>';
            tableViewBtn.innerHTML = '<i class="fa-solid fa-list-ul fa-lg"></i>';
        });

        tableViewBtn.addEventListener('click', function () {
            cardView.style.display = 'none';
            tableView.style.display = 'block';
            tableViewBtn.classList.add('text-primary');
            cardViewBtn.classList.remove('text-primary');
            cardViewBtn.innerHTML = '<i class="fa-solid fa-table-cells-large fa-lg"></i>';
            tableViewBtn.innerHTML = '<i class="fa-solid fa-list-ul fa-lg"></i><i class="fa-solid fa-check ms-1 fa-sm"></i>';
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Socket.IO connection
        const socket = io();

        // Get all required DOM elements
        const cardViewBtn = document.getElementById('cardViewBtn');
        const tableViewBtn = document.getElementById('tableViewBtn');
        const noFile = document.getElementById('noFile');
        const viewToggleBtn = document.getElementById('viewToggleBtn');
        const fileDropOverlay = document.getElementById('fileDropOverlay');
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const selectFilesBtn = document.getElementById('selectFiles');
        const showUploadOverlay = document.getElementById('showUploadOverlay');
        const closeOverlay = document.getElementById('closeOverlay');
        const fileList = document.getElementById('fileList');
        const uploadFiles = document.getElementById('uploadFiles');
        const uploadProgressCard = document.getElementById('uploadProgressCard');
        const uploadProgressList = document.getElementById('uploadProgressList');
        const cancelUploadBtn = document.getElementById('cancelUpload');
        const searchInput = document.getElementById('searchInput');
        const cardView = document.getElementById('cardView');
        const tableView = document.getElementById('tableView');
        let fileQueue = [];
        let filenameMap = {}; // Maps both UUID and original filename to their counterparts
        let isUploading = false;

        // Show file upload overlay
        showUploadOverlay.addEventListener('click', function () {
            fileDropOverlay.style.display = 'block';
        });

        // Close file upload overlay
        closeOverlay.addEventListener('click', function () {
            fileDropOverlay.style.display = 'none';
            resetFileSelection();
        });

        // Cancel entire upload
        cancelUploadBtn.addEventListener('click', function () {
            fileQueue = [];
            isUploading = false;
            uploadProgressCard.style.display = 'none';
            resetFileSelection();
        });

        function resetFileSelection() {
            fileInput.value = '';
            fileList.innerHTML = '';
            uploadProgressList.innerHTML = '';
        }

        selectFilesBtn.addEventListener('click', function () {
            fileInput.click();
        });

        fileInput.addEventListener('change', function (e) {
            addFiles(e.target.files);
        });

        function addFiles(files) {
            Array.from(files).forEach(file => {
                if (!fileQueue.some(qFile => qFile.name === file.name)) {
                    fileQueue.push(file);
                    createProgressItem(file, "Pending");
                }
            });

            uploadProgressCard.style.display = 'block';
        }

        function createProgressItem(file, status = "Pending") {
            const progressItem = document.createElement('div');
            progressItem.classList.add('upload-progress-item');
            progressItem.dataset.filename = file.name; // Store original filename

            progressItem.innerHTML = `
                <div class="d-flex justify-content-between mb-1">
                    <span>${file.name}</span>
                    <span class="upload-status text-warning">${status}</span>
                </div>
                <div class="upload-progress-bar">
                    <div class="upload-progress-bar-fill"></div>
                </div>
                <div class="upload-details">
                    <span class="upload-eta">--:--</span>
                    <span class="upload-speed">0 KB/s</span>
                    <span>${formatFileSize(file.size)}</span>
                </div>
                <button class="btn btn-sm btn-outline-danger cancel-file">Cancel</button>
            `;

            uploadProgressList.appendChild(progressItem);

            progressItem.querySelector('.cancel-file').addEventListener('click', function () {
                const statusEl = progressItem.querySelector('.upload-status');
                statusEl.textContent = 'Cancelled';
                statusEl.classList.replace('text-warning', 'text-danger');
                console.log("File manually cancelled:", file.name);
            });
        }

        uploadFiles.addEventListener('click', function () {
            if (fileQueue.length > 0) {
                fileDropOverlay.style.display = 'none';
                processNextFile();
            }
        });

        function processNextFile() {
            if (fileQueue.length === 0) {
                isUploading = false;
                return;
            }

            if (isUploading) return;

            const file = fileQueue.shift();
            const progressItem = document.querySelector(`.upload-progress-item[data-filename="${file.name}"]`);

            if (progressItem) {
                const statusEl = progressItem.querySelector('.upload-status');
                if (statusEl.textContent === 'Cancelled') {
                    console.log("Skipping cancelled file:", file.name);
                    processNextFile();
                    return;
                }

                statusEl.textContent = 'Uploading...';
                statusEl.classList.replace('text-warning', 'text-primary');
            }

            isUploading = true;
            uploadFile(file);
        }
        // Function to fetch and update the file list dynamically
        function fetchFileList() {
            fetch('/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(files => {
                    updateCardView(files);
                    updateTableView(files);
                })
                .catch(error => console.error("Error fetching files:", error));
        }
        function checkFirstFile(){
            if (noFile.style.display === 'block'){
                noFile.style.display = 'none';
                cardView.style.display = 'flex';
                viewToggleBtn.style.display = 'flex';
            }
        }
        // Function to update Card View
        function updateCardView(files) {
            const cardViewContainer = document.getElementById("cardView");
            cardViewContainer.innerHTML = ""; // Clear existing cards

            files.forEach(file => {
                let fileIcon = getFileIcon(file.mimetype);
                let cardHTML = `
        <div class="col">
          <div class="card h-100 file-card">
            <div class="card-body text-center">
              <div class="file-icon">${fileIcon}</div>
              <h5 class="card-title text-truncate" title="${file.original_filename}">
                ${file.original_filename}
              </h5>
              <p class="card-text text-muted">${(file.size / 1024).toFixed(1)} KB</p>
              <p class="card-text text-muted small">${file.upload_date}</p>
              <div class="d-flex justify-content-center mt-3">
                <a href="/download/${file.id}" class="btn btn-sm btn-outline-primary me-2">Download</a>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteFile('${file.id}', '${file.original_filename}')">Delete</button>
              </div>
            </div>
          </div>
        </div>
      `;
                cardViewContainer.innerHTML += cardHTML;
            });
        }

        // Function to update Table View
        function updateTableView(files) {
            const tableBody = document.querySelector("#tableView tbody");
            tableBody.innerHTML = ""; // Clear existing table rows

            files.forEach(file => {
                let fileIcon = getFileIcon(file.mimetype);
                let rowHTML = `
        <tr>
          <td class="text-center">${fileIcon}</td>
          <td title="${file.original_filename}">${file.original_filename}</td>
          <td>${(file.size / 1024).toFixed(1)} KB</td>
          <td>${file.upload_date}</td>
          <td>
            <div class="d-flex">
              <a href="/download/${file.id}" class="btn btn-sm btn-outline-primary me-2">Download</a>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteFile('${file.id}', '${file.original_filename}')">Delete</button>
            </div>
          </td>
        </tr>
      `;
                tableBody.innerHTML += rowHTML;
            });
        }

        // Function to determine file icon based on mimetype
        function getFileIcon(mimetype) {
            if (mimetype.startsWith("image/")) return '<i class="bi bi-file-image"></i>';
            if (mimetype.startsWith("video/")) return '<i class="bi bi-file-play"></i>';
            if (mimetype.startsWith("audio/")) return '<i class="bi bi-file-music"></i>';
            if (mimetype === "application/pdf") return '<i class="bi bi-file-pdf"></i>';
            if (mimetype.includes("spreadsheet") || mimetype.includes("excel")) return '<i class="bi bi-file-spreadsheet"></i>';
            if (mimetype.includes("document") || mimetype.includes("word")) return '<i class="bi bi-file-word"></i>';
            return '<i class="bi bi-file-earmark"></i>';
        }

        // Function to delete a file
        function deleteFile(fileId, originalFilename) {
            if (!confirm(`Are you sure you want to delete ${originalFilename}?`)) return;

            fetch(`/delete/${fileId}`, { method: "POST" })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        fetchFileList(); // Refresh file list after deletion
                    } else {
                        alert("Failed to delete file.");
                    }
                })
                .catch(error => console.error("Error deleting file:", error));
        }

        // Listen for the 'file_uploaded' event from the server
        socket.on("file_uploaded", function (data) {
            console.log("New file uploaded:", data.filename);
            fetchFileList(); // Refresh file list in real-time
        });

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('sid', socket.id);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.filename && data.original_name) {
                        // Bidirectional mapping
                        filenameMap[data.filename] = data.original_name;
                        filenameMap[data.original_name] = data.filename;

                        console.log('Filename Mapping:', JSON.stringify(filenameMap, null, 2));
                    } else {
                        console.error("Filename mapping error:", data);
                    }
                    checkFirstFile();
                })
                .catch(error => {
                    console.error('Upload error:', error);
                });
        }

        socket.on('upload_progress', function (data) {
            console.log("Full Progress Data:", JSON.stringify(data, null, 2));

            // Try multiple ways to find the original filename
            const possibleFilenames = [
                data.original_name,
                data.filename,
                filenameMap[data.filename],
                filenameMap[data.original_name]
            ].filter(Boolean); // Remove any undefined values

            console.log("Trying Filenames:", possibleFilenames);

            let progressItem = null;
            for (let filename of possibleFilenames) {
                progressItem = document.querySelector(`.upload-progress-item[data-filename="${filename}"]`);
                if (progressItem) break;
            }

            if (progressItem) {
                const progressBar = progressItem.querySelector('.upload-progress-bar-fill');
                const speedEl = progressItem.querySelector('.upload-speed');
                const etaEl = progressItem.querySelector('.upload-eta');

                progressBar.style.width = `${data.progress}%`;
                speedEl.textContent = data.speed;
                etaEl.textContent = data.eta;
            } else {
                console.warn("Progress item not found. Existing Progress Items:",
                    Array.from(document.querySelectorAll('.upload-progress-item'))
                        .map(el => el.dataset.filename)
                );
            }
        });

        socket.on('upload_complete', function (data) {
            console.log("Upload complete:", data.filename);

            // Try multiple ways to find the original filename
            const possibleFilenames = [
                data.original_name,
                data.filename,
                filenameMap[data.filename],
                filenameMap[data.original_name]
            ].filter(Boolean);

            let originalFilename = null;
            for (let filename of possibleFilenames) {
                if (document.querySelector(`.upload-progress-item[data-filename="${filename}"]`)) {
                    originalFilename = filename;
                    break;
                }
            }

            if (!originalFilename) {
                console.warn("No original filename found for completed file:", data.filename);
                return;
            }

            const progressItem = document.querySelector(`.upload-progress-item[data-filename="${originalFilename}"]`);

            if (progressItem) {
                progressItem.classList.add('text-success');
                const statusEl = progressItem.querySelector('.upload-status');
                statusEl.textContent = 'Completed';
                statusEl.classList.replace('text-primary', 'text-success');

                const etaEl = progressItem.querySelector('.upload-eta');
                etaEl.textContent = 'Upload Complete';
            }

            isUploading = false;
            processNextFile();
        });

        socket.on('upload_error', function (data) {
            console.error("Upload error:", data);

            // Try to find and update the corresponding progress item
            const possibleFilenames = [
                data.original_name,
                data.filename,
                filenameMap[data.filename],
                filenameMap[data.original_name]
            ].filter(Boolean);

            let originalFilename = null;
            for (let filename of possibleFilenames) {
                if (document.querySelector(`.upload-progress-item[data-filename="${filename}"]`)) {
                    originalFilename = filename;
                    break;
                }
            }

            if (originalFilename) {
                const progressItem = document.querySelector(`.upload-progress-item[data-filename="${originalFilename}"]`);
                if (progressItem) {
                    const statusEl = progressItem.querySelector('.upload-status');
                    statusEl.textContent = 'Error';
                    statusEl.classList.replace('text-primary', 'text-danger');

                    const etaEl = progressItem.querySelector('.upload-eta');
                    etaEl.textContent = data.error || 'Upload Failed';
                }
            }

            isUploading = false;
            processNextFile();
        });

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // Drag and Drop functionality
        dropArea.addEventListener('dragover', function (e) {
            e.preventDefault();
            e.stopPropagation();
            dropArea.classList.add('dragover');
        });

        dropArea.addEventListener('dragleave', function (e) {
            e.preventDefault();
            e.stopPropagation();
            dropArea.classList.remove('dragover');
        });

        dropArea.addEventListener('drop', function (e) {
            e.preventDefault();
            e.stopPropagation();
            dropArea.classList.remove('dragover');

            const files = e.dataTransfer.files;
            addFiles(files);
        });
        searchInput.addEventListener('input', function () {
            const searchTerm = this.value.trim().toLowerCase();

            // Only start searching if 3 or more characters
            if (searchTerm.length >= 3) {
                performSearch(searchTerm);
            } else {
                // Show all files if search term is less than 3 characters
                resetSearch();
            }
        });

        function performSearch(searchTerm) {
            // Search in Card View
            const cardFiles = cardView.querySelectorAll('.col');
            cardFiles.forEach(cardFile => {
                const filename = cardFile.querySelector('.card-title').textContent.trim().toLowerCase();

                if (filename.includes(searchTerm)) {
                    cardFile.style.display = 'block';
                } else {
                    cardFile.style.display = 'none';
                }
            });

            // Search in Table View
            const tableRows = tableView.querySelectorAll('tbody tr');
            tableRows.forEach(row => {
                const filename = row.querySelector('td:nth-child(2)').textContent.trim().toLowerCase();

                if (filename.includes(searchTerm)) {
                    row.style.display = 'table-row';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function resetSearch() {
            // Reset Card View
            const cardFiles = cardView.querySelectorAll('.col');
            cardFiles.forEach(cardFile => {
                cardFile.style.display = 'block';
            });

            // Reset Table View
            const tableRows = tableView.querySelectorAll('tbody tr');
            tableRows.forEach(row => {
                row.style.display = 'table-row';
            });
        }
        fetchFileList()
    });
</script>
{%endblock%}