<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload Overlay</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .file-drop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1050;
            backdrop-filter: blur(5px);
        }

        .file-drop-card {
            max-width: 600px;
            margin: 10% auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .file-drop-area {
            border: 2px dashed #6c757d;
            border-radius: 20px;
            padding: 40px 20px;
            text-align: center;
            transition: background-color 0.3s ease;
        }

        .file-drop-area.dragover {
            background-color: rgba(0, 123, 255, 0.1);
            border-color: #007bff;
        }

        #fileList {
            max-height: 300px;
            overflow-y: auto;
        }

        .file-upload-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            position: relative;
        }

        .upload-progress-card {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1100;
            padding: 15px;
        }

        .upload-progress-item {
            margin-bottom: 10px;
            position: relative;
        }

        .upload-progress-bar {
            height: 5px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }

        .upload-progress-bar-fill {
            height: 100%;
            background-color: #28a745;
            width: 0%;
            transition: width 0.5s ease;
        }

        .upload-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="display-4">Simple Drive</h1>
                <p class="lead text-muted">Upload, download, and manage your files</p>
            </div>
            <div class="col-md-4 d-flex align-items-center justify-content-end">
                <button id="showUploadOverlay" class="btn btn-primary">Upload Files</button>
            </div>
        </div>

        <div id="fileDropOverlay" class="file-drop-overlay">
            <div class="file-drop-card card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Upload Files</h5>
                    <button id="closeOverlay" class="btn-close" aria-label="Close"></button>
                </div>
                <div class="card-body">
                    <div id="dropArea" class="file-drop-area">
                        <p class="text-muted mb-3">Drag and drop files here or click to select</p>
                        <input type="file" id="fileInput" multiple class="form-control" style="display:none;">
                        <button id="selectFiles" class="btn btn-outline-primary">Select Files</button>
                    </div>
                    
                    <div id="fileList" class="mt-3">
                        <!-- Selected files will be listed here -->
                    </div>

                    <div class="mt-3 d-flex justify-content-end">
                        <button id="uploadFiles" class="btn btn-primary">Upload Files</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="uploadProgressCard" class="upload-progress-card" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">Upload Progress</h6>
                <button id="cancelUpload" class="btn btn-sm btn-outline-danger">&times;</button>
            </div>
            <div id="uploadProgressList">
                <!-- Upload progress items will be added here -->
            </div>
        </div>
    </div>

    <!-- Socket.IO Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Socket.IO connection
    const socket = io();

    // Get all required DOM elements
    const fileDropOverlay = document.getElementById('fileDropOverlay');
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    const selectFilesBtn = document.getElementById('selectFiles');
    const showUploadOverlay = document.getElementById('showUploadOverlay');
    const closeOverlay = document.getElementById('closeOverlay');
    const fileList = document.getElementById('fileList');
    const uploadFiles = document.getElementById('uploadFiles');
    const uploadProgressCard = document.getElementById('uploadProgressCard');
    const uploadProgressList = document.getElementById('uploadProgressList');
    const cancelUploadBtn = document.getElementById('cancelUpload');

    let fileQueue = [];
    let filenameMap = {}; // Maps both UUID and original filename to their counterparts
    let isUploading = false;

    // Show file upload overlay
    showUploadOverlay.addEventListener('click', function() {
        fileDropOverlay.style.display = 'block';
    });

    // Close file upload overlay
    closeOverlay.addEventListener('click', function() {
        fileDropOverlay.style.display = 'none';
        resetFileSelection();
    });

    // Cancel entire upload
    cancelUploadBtn.addEventListener('click', function() {
        fileQueue = [];
        isUploading = false;
        uploadProgressCard.style.display = 'none';
        resetFileSelection();
    });

    function resetFileSelection() {
        fileInput.value = '';
        fileList.innerHTML = '';
        uploadProgressList.innerHTML = '';
    }

    selectFilesBtn.addEventListener('click', function() {
        fileInput.click();
    });

    fileInput.addEventListener('change', function(e) {
        addFiles(e.target.files);
    });

    function addFiles(files) {
        Array.from(files).forEach(file => {
            if (!fileQueue.some(qFile => qFile.name === file.name)) {
                fileQueue.push(file);
                createProgressItem(file, "Pending");
            }
        });

        uploadProgressCard.style.display = 'block';
    }

    function createProgressItem(file, status = "Pending") {
        const progressItem = document.createElement('div');
        progressItem.classList.add('upload-progress-item');
        progressItem.dataset.filename = file.name; // Store original filename

        progressItem.innerHTML = `
            <div class="d-flex justify-content-between mb-1">
                <span>${file.name}</span>
                <span class="upload-status text-warning">${status}</span>
            </div>
            <div class="upload-progress-bar">
                <div class="upload-progress-bar-fill"></div>
            </div>
            <div class="upload-details">
                <span class="upload-eta">--:--</span>
                <span class="upload-speed">0 KB/s</span>
                <span>${formatFileSize(file.size)}</span>
            </div>
            <button class="btn btn-sm btn-outline-danger cancel-file">Cancel</button>
        `;

        uploadProgressList.appendChild(progressItem);

        progressItem.querySelector('.cancel-file').addEventListener('click', function() {
            const statusEl = progressItem.querySelector('.upload-status');
            statusEl.textContent = 'Cancelled';
            statusEl.classList.replace('text-warning', 'text-danger');
            console.log("File manually cancelled:", file.name);
        });
    }

    uploadFiles.addEventListener('click', function() {
        if (fileQueue.length > 0) {
            fileDropOverlay.style.display = 'none';
            processNextFile();
        }
    });

    function processNextFile() {
        if (fileQueue.length === 0) {
            isUploading = false;
            return;
        }

        if (isUploading) return;

        const file = fileQueue.shift();
        const progressItem = document.querySelector(`.upload-progress-item[data-filename="${file.name}"]`);
        
        if (progressItem) {
            const statusEl = progressItem.querySelector('.upload-status');
            if (statusEl.textContent === 'Cancelled') {
                console.log("Skipping cancelled file:", file.name);
                processNextFile();
                return;
            }

            statusEl.textContent = 'Uploading...';
            statusEl.classList.replace('text-warning', 'text-primary');
        }

        isUploading = true;
        uploadFile(file);
    }

    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('sid', socket.id);

        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.filename && data.original_name) {
                // Bidirectional mapping
                filenameMap[data.filename] = data.original_name;
                filenameMap[data.original_name] = data.filename;
                
                console.log('Filename Mapping:', JSON.stringify(filenameMap, null, 2));
            } else {
                console.error("Filename mapping error:", data);
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
        });
    }

    socket.on('upload_progress', function(data) {
        console.log("Full Progress Data:", JSON.stringify(data, null, 2));

        // Try multiple ways to find the original filename
        const possibleFilenames = [
            data.original_name,
            data.filename,
            filenameMap[data.filename],
            filenameMap[data.original_name]
        ].filter(Boolean); // Remove any undefined values

        console.log("Trying Filenames:", possibleFilenames);

        let progressItem = null;
        for (let filename of possibleFilenames) {
            progressItem = document.querySelector(`.upload-progress-item[data-filename="${filename}"]`);
            if (progressItem) break;
        }

        if (progressItem) {
            const progressBar = progressItem.querySelector('.upload-progress-bar-fill');
            const speedEl = progressItem.querySelector('.upload-speed');
            const etaEl = progressItem.querySelector('.upload-eta');

            progressBar.style.width = `${data.progress}%`;
            speedEl.textContent = data.speed;
            etaEl.textContent = data.eta;
        } else {
            console.warn("Progress item not found. Existing Progress Items:", 
                Array.from(document.querySelectorAll('.upload-progress-item'))
                    .map(el => el.dataset.filename)
            );
        }
    });

    socket.on('upload_complete', function(data) {
        console.log("Upload complete:", data.filename);

        // Try multiple ways to find the original filename
        const possibleFilenames = [
            data.original_name,
            data.filename,
            filenameMap[data.filename],
            filenameMap[data.original_name]
        ].filter(Boolean);

        let originalFilename = null;
        for (let filename of possibleFilenames) {
            if (document.querySelector(`.upload-progress-item[data-filename="${filename}"]`)) {
                originalFilename = filename;
                break;
            }
        }

        if (!originalFilename) {
            console.warn("No original filename found for completed file:", data.filename);
            return;
        }

        const progressItem = document.querySelector(`.upload-progress-item[data-filename="${originalFilename}"]`);

        if (progressItem) {
            progressItem.classList.add('text-success');
            const statusEl = progressItem.querySelector('.upload-status');
            statusEl.textContent = 'Completed';
            statusEl.classList.replace('text-primary', 'text-success');

            const etaEl = progressItem.querySelector('.upload-eta');
            etaEl.textContent = 'Upload Complete';
        }

        isUploading = false;
        processNextFile();
    });

    socket.on('upload_error', function(data) {
        console.error("Upload error:", data);

        // Try to find and update the corresponding progress item
        const possibleFilenames = [
            data.original_name,
            data.filename,
            filenameMap[data.filename],
            filenameMap[data.original_name]
        ].filter(Boolean);

        let originalFilename = null;
        for (let filename of possibleFilenames) {
            if (document.querySelector(`.upload-progress-item[data-filename="${filename}"]`)) {
                originalFilename = filename;
                break;
            }
        }

        if (originalFilename) {
            const progressItem = document.querySelector(`.upload-progress-item[data-filename="${originalFilename}"]`);
            if (progressItem) {
                const statusEl = progressItem.querySelector('.upload-status');
                statusEl.textContent = 'Error';
                statusEl.classList.replace('text-primary', 'text-danger');

                const etaEl = progressItem.querySelector('.upload-eta');
                etaEl.textContent = data.error || 'Upload Failed';
            }
        }

        isUploading = false;
        processNextFile();
    });

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' bytes';
        else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
        else return (bytes / 1048576).toFixed(1) + ' MB';
    }

    // Drag and Drop functionality
    dropArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropArea.classList.add('dragover');
    });

    dropArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropArea.classList.remove('dragover');
    });

    dropArea.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropArea.classList.remove('dragover');

        const files = e.dataTransfer.files;
        addFiles(files);
    });
});
        </script>
        
</body>
</html>